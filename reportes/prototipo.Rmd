---
output: 
    html_document:
        css: estilo.css
params:
    mi_anp:
        value: anp_terrestres_2017_NOMBRE_El_Triunfo
---

<!-- css -->

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
# library(DT)
library(raster)
# library(sf)
library(dplyr)
library(ggplot2)
library(stringr)
library(purrr)
library(knitr)
library(maptools)
library(kableExtra)
library(plotly)
library(leaflet)
library(leaflet.extras)
library(tidyr)
library(readr)

knitr::opts_chunk$set(echo = FALSE, fig.align="center", message = FALSE, 
    warning = FALSE, cache = FALSE)
comma <- function(x) format(x, digits = 3, big.mark = ",")
obtener_anps <- function(mi_anp){
    mi_info <- manejo_ha_anp %>% 
        filter(anp == mi_anp)
    tab_eco <- filter(manejo_ha_anp, eco == pull(mi_info, eco))
    if (nrow(tab_eco) > 5){
        mi_tamano <-  pull(mi_info, S_TERRES)
        tab_eco <- tab_eco %>% 
            ungroup() %>% 
            mutate(dist = abs(S_TERRES - mi_tamano)) %>% 
            arrange(dist) %>% 
            top_n(n = 6, -dist) 
    }
    pull(tab_eco, anp)
}
theme_set(theme_minimal())

anp_nombres <- readr::read_delim("../datos_insumo/anp_nombres.tsv", "\t", 
    escape_double = FALSE, trim_ws = TRUE)
manejo_ha_anp <- read_csv("../datos_procesados/2019-01-15_manejo_ha_extent_anp.csv")

mi_anp <- params$mi_anp
mi_anp_nombres <- anp_nombres %>% 
    filter(anp_sin_acentos == mi_anp)
mi_anp_id_07 <- manejo_ha_anp$id_07[manejo_ha_anp$anp == mi_anp]
mi_anp_corto <- mi_anp_nombres$anp_corto
mi_anp_print <- str_replace_all(mi_anp_nombres$anp, "_", " ")
mis_anps_eco <- obtener_anps(mi_anp)
```

```{r}
estilos <- rjson::fromJSON(file = "../datos_insumo/spatial_layers_styles.json")
estilos_df <- estilos %>% 
    flatten() %>% 
    map_df(~tibble(layer = .$layer, labels = list(.$data_labels), 
        colors = list(.$colors)))
rm(estilos)
```


## ANP `r mi_anp_print ` {.tabset}

### Descriptivos 

#### Ecorregiones 

```{r shapes}
# path_anps_shp <- "../datos_insumo/shapes_anp/anp_sinBuffer/"
# path_anps_rings_shp <- "../datos_insumo/shapes_anp/anp_rings/"
# mi_anp_shp_file <- list.files(path_anps_shp, 
#     pattern = str_c(mi_anp, ".shp"), recursive = FALSE) %>%
#     tools::file_path_sans_ext() 
# mi_anp_shp <- rgdal::readOGR(path_anps_shp, mi_anp_shp_file, verbose = FALSE)

# mi_anp_shp_file <- list.files(path_anps_shp, 
#     pattern = str_c(mi_anp, ".shp"), full.names = TRUE)
# mi_anp_shp <- read_sf(mi_anp_shp_file)
```


```{r tabla_eco, eval = TRUE, echo = FALSE, message=FALSE}
# por ahora cada ANP se asigna a una sola ecorregión, la más prevalente
load("../datos_procesados/2018-08-08_ecorregion.RData")
load("../datos_procesados/2018-08-08_area_rings.RData")

anp_rings_eco_df <- anps_area_anillos %>% 
    distinct() %>% 
    mutate(
      anp = str_replace(anp, "_ring", "")
    ) %>% 
    rename(ha_anillo = hectareas)

mi_eco_info <- manejo_ha_anp %>% 
    filter(anp == mi_anp) 

mi_eco <- mi_eco_info %>% 
    pull(eco)

anp_eco_table <- manejo_ha_anp %>% 
    filter(anp %in% mis_anps_eco, !is.na(anp)) %>% 
    left_join(anp_rings_eco_df, by = "anp") %>% 
    mutate(
        ha = comma(round(hectareas)), 
        ha_anillo = comma(round(ha_anillo))
        ) %>% 
    dplyr::select(anp, cat_manejo, ha, ha_anillo) %>% 
    arrange(desc(ha))

titulo_tab <- c(4)
names(titulo_tab) <- c(mi_eco)

anp_eco_table %>% 
    left_join(anp_nombres, by = c("anp" = "anp_sin_acentos")) %>% 
    select(anp_corto, cat_manejo, ha, ha_anillo) %>% 
    kable("html", align = c("r", "c", "c", "c"), padding = 10, 
        col.names = c("", "cat", "ANP ha", "Periferia ha")) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
        position = "float_right", font_size = 11, full_width = FALSE) %>% 
    row_spec(which(anp_eco_table$anp == mi_anp), bold = F, color = "#79797d", 
        background = "mistyrose") %>% 
    row_spec(1:nrow(anp_eco_table), color = "#79797d")  %>%
    add_header_above(titulo_tab) # %>%
    # scroll_box(width = "100px", height = "200px", box_css = "float: right;") 
    # group_rows("Selvas Cálido-Húmedas", label_row_css = "color: #79797d;", 1, 37)
```

A lo largo del reporte los indicadores del área natural protegida (ANP) objetivo 
se comparan con los indicadores de otras ANP de la misma ecorregión, esto se 
hace para poder contextuaizar los valores obtenidos. Utilizamos la definición de 
ecorregión del mapa de [Ecorregiones terrestres de México (2008)](http://www.conabio.gob.mx/informacion/metadata/gis/ecort08gw.xml?_xsl=/db/metadata/xsl/fgdc_html.xsl&_indent=no) 
elaborado por INEGI, CONABIO e INE.

La tabla de abajo indica para cada ecorregión cuántas hectáreas hay en ANP y el 
número de ANP con territorio en cada una.

```{r}
load("../datos_procesados/2018-08-08_ecorregion.RData")
anp_eco_df_table <- anp_eco_df %>%
    group_by(eco) %>%
    summarise(
        hectareas = round(sum(hectareas)),
        n_anps = n()
    ) %>%
    arrange(hectareas) %>%
    mutate(hectareas = comma(hectareas)) 

anp_eco_df_table %>% 
    kable("html", col.names = c("", "ha", "# ANPs")) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
        position = "left", font_size = 12, full_width = FALSE) %>% 
    row_spec(which(anp_eco_df_table$eco == mi_eco), bold = F, color = "#79797d", 
        background = "mistyrose")
```

A cada ANP le asignamos la ecorregión de mayor prevalencia, es decir, si la ANP
pertenece a más de una ecorregión le asignamos aquella donde esté la mayor 
parte de su terreno. En el caso de la ANP *`r mi_anp_print`* se le asignó la ecorregión
`r mi_eco`, que engloba el `r round(mi_eco_info$p_area_eco)`% del área total de 
la ANP. Por tanto, en los siguientes análisis se compararán los 
indicadores de las ANPs asignadas a la ecorregión `r mi_eco` y si es posible
de tamaño similar.

#### Periferias, Zonas núcleo y Zonas de Preservación

Adicional a la comparación con otras ANP comparamos los distintos indicadores dentro de las ANP los equivalentes alrededor de las mismas, para esto se definieron los anillos como el área de los 25 km circundantes a cada ANP, así como en Zonas núcleo y Zonas de preservación si las ANP las presentan.

Vale la pena notar que el anillo de la ANP puede no corresponder a la misma ecorregión, puede pertenecer a otra ANP cercana o puede representar un superficie mayor a la de la propia ANP, sin embargo, consideramos que, teniendo esto en cuenta, es informativo conocer los indicadores en esta zona, la cual representa el grado de presión antropogénica circundante.
En el caso de la ANP *`r mi_anp_print`* el área total de su anillo resulta en 
`r comma(filter(anp_eco_table, anp == mi_anp)$ha_anillo)` hectáreas. La tabla del 
lado derecho indica la extensión de los anillos para las ANPs asignadas a la misma 
ecorregión que *`r mi_anp_print`*.

<div style="clear:both">
</div>

```{r}
mi_region <- manejo_ha_anp %>% 
    filter(anp == mi_anp) %>% 
    pull(region)

mis_anps_region <- manejo_ha_anp %>% 
    filter(region %in% mi_region) %>% pull(anp)

anp_region_table <- manejo_ha_anp %>% 
    filter(anp %in% mis_anps_region, region %in% mi_region) %>%
    left_join(anp_rings_eco_df, by = "anp") %>% 
    left_join(anp_nombres, by = c("anp" = "anp_sin_acentos")) %>% 
    mutate(
        hectareas = comma(round(S_TERRES)), 
        hectareas_ring = comma(round(ha_anillo))
        # anp = str_replace_all(str_sub(anp, start = 1, end = 20), "_", " ")
        ) %>% 
    arrange(desc(hectareas))

titulo_tab_region <- c(4)
names(titulo_tab_region) <- mi_region
anp_region_table %>% 
    dplyr::select(anp_corto, cat_manejo, hectareas, hectareas_ring) %>%
    kable("html", align = c("r", "c", "c", "c"), padding = 10, 
        col.names = c("", "cat", "ANP ha", "Periferia ha")) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
        position = "float_right", font_size = 11, full_width = FALSE) %>% 
    row_spec(which(anp_region_table$anp == mi_anp), bold = F, color = "#79797d", 
        background = "mistyrose") %>% 
    row_spec(1:nrow(anp_region_table), color = "#79797d")  %>%
    add_header_above(titulo_tab_region)
```

#### Regiones CONANP

Adicional a los análisis de ecorregión agregamos comparativos con las regiones
CONANP, la tabla de abajo indica cuantas hectáreas hay en las ANP correspondientes 
a cada región y el número de ANPs de cada una.


```{r}
anp_region_eco_table <- manejo_ha_anp %>% 
    group_by(region) %>%
    summarise(
        hectareas = round(sum(S_TERRES)),
        n_anps = n()
    ) %>%
    arrange(hectareas) %>%
    mutate(hectareas = comma(hectareas)) 

anp_region_eco_table %>% 
    kable("html", col.names = c("", "ha", "# ANPs")) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
        position = "left", font_size = 11, full_width = FALSE) %>% 
    row_spec(which(anp_region_eco_table$region == mi_region), bold = F, 
        color = "#79797d", background = "mistyrose") 
```
La tabla de la derecha indica las ANP de la región, las hectáreas que comprende
cada una y la extensión de los anillos que las rodean.


<div style="clear:both">
</div>


### Cobertura de suelo 

#### Clases de cobertura

```{r tabla_madmex}
# madmex <- raster("../rasters/mapabase_8clases_re_2015_30m_wgs84nodefs_cropped.tif")
# madmex_mi_anp <- madmex %>% 
#     raster::crop(mi_anp_shp) %>%
#     mask(mask = mi_anp_shp)

madmex_cobertura <- read_csv("../datos_procesados/2018-09-06_cobertura.csv")
madmex_mi_anp_tab <- madmex_cobertura %>% 
    filter(anp == mi_anp, tipo_id == 1) %>% 
    mutate(clase = case_when(
        clase_madmex == 1 ~ "bosque templado",
        clase_madmex == 2 ~ "selva",
        clase_madmex == 3 ~ "matorral",
        clase_madmex == 4 ~ "vegetación menor y pastizales",
        clase_madmex == 5 ~ "tierras agrícolas",
        clase_madmex == 6 ~ "urbano y construido",
        clase_madmex == 7 ~ "suelo desnudo",
        clase_madmex == 8 ~ "agua"
    )) %>% 
    group_by(clase) %>% 
    summarise(n = sum(n)) %>% 
    ungroup() %>% 
    mutate(prop = round(100 * (n / sum(n)), 1))

madmex_mi_anp_tab %>% 
    select(-n) %>% 
    arrange(-prop) %>% 
    filter(prop > 1) %>% 
    kable("html", col.names = c("", "% área")) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
        position = "float_right", font_size = 11, full_width = FALSE)
```
CAMBIAR 


La clasificación de la cobertura de suelo se realiza con un algoritmo automatizado, 
que genera un mapa con resolución espacial de 30 m^2^, construido a partir de 
imágenes Landsat correspondientes al año 2010. Temáticamente se agregó para 
contar con 10 clases:  bosques, selvas, matorrales, pastizal, 
sin vegetación aparente, humedal, agricultura, asentamiento humano, agua y nieve/hielo.

La tabla de la derecha nos muestra el porcentaje del área de la ANP *`r mi_anp_print`* 
que pertence a cada clase de acuerdo al mapa 2010.

</br>

Veamos la composición espacial de las clases en la ANP *`r mi_anp_print`*.

```{r madmex_map}
xmin <- mi_eco_info$xmin
xmax <- mi_eco_info$xmax
ymin <- mi_eco_info$ymin
ymax <- mi_eco_info$ymax

estilos_madmex <- filter(estilos_df, layer == "mex_RE_2015_8_clases")

leaflet() %>% 
    fitBounds(lng1 = xmin, lat1 = ymin, lng2 = xmax, lat2 = ymax) %>% 
    addProviderTiles(providers$Esri.WorldImagery) %>% 
    addProviderTiles(providers$Esri.WorldImagery, group = "Terreno") %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/geoportal/wms",
        layers = "mex_RE_2015_8_clases",
        options = WMSTileOptions(format = "image/png", transparent = TRUE), 
        group = "Capa"
        ) %>%
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/geoportal/wms",
        layers = "mex_ANPTerr175_2017",
        options = WMSTileOptions(format = "image/png", transparent = TRUE, 
        opacity = 0.5), group = "ANP"
        ) %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/geoportal/wms",
        layers = "mex_ZN_terr_geoITRF08_Mayo18",
        options = WMSTileOptions(format = "image/png", transparent = TRUE, 
        opacity = 0.6), group = "Núcleo-Pres."
        ) %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/reportes/wms",
        layers = "mex_ANPTerr175_2017_rings",
        options = WMSTileOptions(format = "image/png", transparent = TRUE, 
        opacity = 0.3), group = "Periferia"
        ) %>% 
    # addWMSLegend(
    #     uri = paste0('https://monitoreo.conabio.gob.mx/geoserver/geoportal/wms?',
    #         'REQUEST=GetLegendGraphic',
    #         '&FORMAT=image/png&LAYER=workspace:mex_RE_2015_8_clases')) # %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/reportes/wms",
        layers = "GapPriorExtrema", group = "GAP",
        options = WMSTileOptions(format = "image/png", transparent = TRUE)) %>%
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/reportes/wms",
         layers = "LocPob2500", group = "Loc 2500",
         options = WMSTileOptions(format = "image/png", transparent = TRUE)
        ) %>%
    addLegend("bottomright", colors = estilos_madmex$colors[[1]],
        title = "MAD-MEX (2015)", labels = estilos_madmex$labels[[1]], 
        opacity = 1, group = "leyenda") %>%
    addLayersControl(
        baseGroups = c("Capa", "Terreno"),
        overlayGroups = c("leyenda", "ANP", "GAP", "Loc 2500", "Periferia", 
            "Núcleo-Pres."),
        options = layersControlOptions(collapsed = FALSE)
        )  %>%
    hideGroup("GAP") %>% 
    hideGroup("Loc 2500") %>% 
    hideGroup("Periferia") %>% 
    hideGroup("Núcleo-Pres.") 
```


#### Tasa de transformación de cobertura boscosa
<!--
Utilizamos los datos de [Cambios en cobertura forestal](https://earthenginepartners.appspot.com/science-2013-global-forest) de 
Hansen, Potapov, Moore, Hancher et al. Estos datos son resultado de análisis de 
series de tiempo de imágenes Landsat, el producto final es un mapa con información de 
deforestación para los años 2000 a 2014, con una resolución de 30 m^2^.
-->

El siguiente mapa muestra en rojo las zonas que se identificaron como pérdida de
cobertura forestal en los últimos 5 años de datos, esto es entre 2012 y 2017.

```{r hansen}
estilos_hansen <- filter(estilos_df, layer == "mex_LSperdida_2001_2017")

leaflet() %>% 
    fitBounds(lng1 = xmin, lat1 = ymin, lng2 = xmax, lat2 = ymax) %>% 
    addProviderTiles(providers$Esri.WorldImagery) %>% 
    addProviderTiles(providers$Esri.WorldImagery, group = "Terreno") %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/geoportal/wms",
        layers = "mex_LSperdida_2001_2017",
        options = WMSTileOptions(format = "image/png", transparent = TRUE), 
        group = "Capa"
        ) %>%
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/geoportal/wms",
        layers = "mex_ANPTerr175_2017",
        options = WMSTileOptions(format = "image/png", transparent = TRUE, 
        opacity = 0.5), group = "ANP"
        ) %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/geoportal/wms",
        layers = "mex_ZN_terr_geoITRF08_Mayo18",
        options = WMSTileOptions(format = "image/png", transparent = TRUE, 
        opacity = 0.6), group = "Núcleo-Pres."
        ) %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/reportes/wms",
        layers = "mex_ANPTerr175_2017_rings",
        options = WMSTileOptions(format = "image/png", transparent = TRUE, 
        opacity = 0.3), group = "Periferia"
        ) %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/reportes/wms",
        layers = "GapPriorExtrema", group = "GAP",
        options = WMSTileOptions(format = "image/png", transparent = TRUE)) %>%
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/reportes/wms",
         layers = "LocPob2500", group = "Loc 2500",
         options = WMSTileOptions(format = "image/png", transparent = TRUE)
        ) %>%
    addLegend("bottomright", colors = estilos_hansen$colors[[1]],
        title = "Pérdida", labels = estilos_hansen$labels[[1]], 
        opacity = 1, group = "leyenda") %>%
    addLayersControl(
        baseGroups = c("Capa", "Terreno"),
        overlayGroups = c("leyenda", "ANP", "GAP", "Loc 2500", "Periferia", 
            "Núcleo-Pres."),
        options = layersControlOptions(collapsed = FALSE)
        )  %>%
    hideGroup("GAP") %>% 
    hideGroup("Loc 2500") %>% 
    hideGroup("Periferia") %>% 
    hideGroup("Núcleo-Pres.")
```
</br>

Ahora veamos el impacto de la deforestación año a año, y para cada tipo de 
cobertura.

<!-- En las gráficas de abajo la línea roja representa la pérdida como porcentaje del 
área total del ANP, la línea azul representa el porcentaje de área perdida en el 
anillo y las líneas grises el equivalente en las ANPs de la ecorregión. En la 
gráfica del lado izquierdo podemos leer los resultados a total mientras 
que los paneles del lado derecho cada cobertura de uso de suelo. -->

En las gráficas de abajo la línea roja representa la transformación de cobertura boscosa en la ANP, 
la línea azul representa la misma transformación en el anillo circundante
y las líneas grises el equivalente en las otras ANP de la ecorregión. En la 
gráfica del lado izquierdo podemos leer los resultados totales, mientras 
que los paneles del lado derecho cada cobertura de uso de suelo. Al situar el 
cursor sobre la gráfica se informa también la pérdida de cobertura boscosa media en hectáreas.

```{r deforestacion_tiempo, fig.width = 8, fig.height=4.5}
perdida_anps_df <- madmex_cobertura %>% 
    filter((anp %in% mis_anps_eco & tipo_id == 1) | 
        (anp == mi_anp & tipo_id == 2) | (anp == mi_anp & tipo_id == 3) | 
        (anp == mi_anp & tipo_id == 4)) %>% 
    mutate(
        clase = case_when(
            tipo_id == 2 ~ "periferia",
            tipo_id == 3 ~ "z.núcleo",
            tipo_id == 4 ~ "z.preservación",
            anp == mi_anp ~ mi_anp_corto,
            TRUE ~ "otras")
        )

perdida_anual_porcentaje <- perdida_anps_df %>% 
    group_by(anio_perdida, anp, clase) %>% 
    summarise(n = sum(n)) %>% 
    group_by(anp, clase) %>% 
    mutate(
        percent_loss = round(n / sum(n) * 100, 3), 
        ha_loss = n * 3 * 3 / 100) %>% 
    ungroup()
escala_color <- c("gray50", "#005b96", "#7CCD7C", "#AB82FF", "#ff420e")
names(escala_color) <- c("otras", "periferia", "z.núcleo", "z.preservación",  
    mi_anp_corto)
escala_alpha <- c(0.1, 0.8, 0.8, 0.8, 1)
names(escala_alpha) <- c("otras", "periferia", "z.núcleo", "z.preservación",  
    mi_anp_corto)

perdida_anual_cobertura_porcentaje <- perdida_anps_df %>% 
    group_by(anio_perdida, anp, clase, clase_madmex) %>% 
    summarise(n = sum(n)) %>% 
    group_by(anp, clase, clase_madmex) %>% 
    mutate(
        percent_loss = round(n / sum(n) * 100, 3), 
        ha_loss = n * 3 * 3 / 100
        ) %>%  
    ungroup() %>% 
    filter(anio_perdida > 2000, clase_madmex %in% c(1:3, 6)) %>% 
    mutate(clase_madmex = case_when(
        clase_madmex == 1 ~ "bosque", 
        clase_madmex == 2 ~ "selva", 
        clase_madmex == 3 ~ "matorral"
        )
        )

# perdida_anual_cobertura_mi_anp <- filter(perdida_anual_cobertura_porcentaje, anp == mi_anp)
# perdida_anual_cobertura_mi_anp_ring <- filter(perdida_anual_cobertura_porcentaje, anp == str_c(mi_anp, "_ring"))
# 
# perdida_anual_cobertura_porcentaje_cl <- perdida_anual_cobertura_porcentaje %>% 
#     left_join(anp_nombres, by = c("anp" = "anp_sin_acentos")) %>% 
#     mutate(
#         anp = ifelse(anp == stringr::str_c(mi_anp, "_ring"), 
#             str_c(mi_anp_corto, " anillo"), anp_corto),
#         )  %>% 
#     select(ANP = anp, año = year_loss, perdida = percent_loss, perdida_ha = ha_loss, 
#         clase, clase_madmex)
 
# perdida_anual_cobertura_plot <- ggplot(perdida_anual_cobertura_porcentaje_cl, 
#     aes(x = año, y = perdida, label = perdida_ha, group = ANP)) + 
#     geom_line(aes(color = clase, alpha = clase), show.legend = FALSE) +
#     scale_alpha_manual(values = escala_alpha) +
#     scale_color_manual(values = escala_color) +
#     facet_wrap(~clase_madmex) +
#     labs(y = "% área", x = "año", title = "Pérdida anual (% área)", color = "", 
#          alpha = "") +
#     ylim(0, max(quantile(perdida_anual_cobertura_porcentaje$percent_loss, 0.8),
#         max(perdida_anual_cobertura_mi_anp$percent_loss), 
#         max(perdida_anual_cobertura_mi_anp_ring$percent_loss)))
# 
# vars_tooltip <- c("ANP", "perdida_ha", "perdida", "año")
# p1 <- ggplotly(perdida_anual_plot, tooltip = vars_tooltip, 
#                  dynamicTicks = TRUE)
# p2 <- ggplotly(perdida_anual_cobertura_plot, tooltip = vars_tooltip, 
#                  dynamicTicks = TRUE)
# subplot(style(p1, traces = 1:3, showlegend = FALSE), p2, margin = 0.03)
```


```{r tasa_cambio, fig.width = 8, fig.height=4.5}
tasa_cambio_aux <- perdida_anps_df %>% 
    group_by(anio_perdida, anp, clase) %>% 
    summarise(n = sum(n)) %>% 
    group_by(anp, clase) %>% 
    mutate(
        area_total = sum(n)
    )

tasa_cambio_aux$n[tasa_cambio_aux$anio_perdida == 2000] <- 0

tasa_cambio <- tasa_cambio_aux %>% 
    group_by(anp, clase) %>% 
    mutate(
        cum_loss = cumsum(n),
        area_restante = area_total - cum_loss, 
        tasa_cambio = round(100 * (area_restante / lag(area_restante) - 1), 3)
        ) %>% 
    filter(anio_perdida > 2000) %>% 
    ungroup() %>% 
    select(anp, anio_perdida, tasa_cambio, clase)

tasa_cambio_cl <- tasa_cambio %>% 
  left_join(perdida_anual_porcentaje, by = c("anp", "anio_perdida", "clase")) %>% 
  left_join(anp_nombres, by = c("anp" = "anp_sin_acentos")) %>% 
    filter(anio_perdida >= 2015) %>% 
    select(anp, ANP = anp_corto, año = anio_perdida, THH = tasa_cambio, 
        perdida_ha = ha_loss, clase)

tasa_cambio_mi_anp <- filter(tasa_cambio_cl, anp == mi_anp)
tasa_cambio_mi_anp_ring <- filter(tasa_cambio_cl, clase == "periferia")

tasa_cambio_plot <- ggplot(tasa_cambio_cl, aes(label = perdida_ha)) + 
    geom_line(aes(x = año, y = THH, group = interaction(ANP, clase), 
        color = clase, alpha = clase)) +
    scale_alpha_manual(values = escala_alpha) +
    scale_color_manual(values = escala_color) +
    scale_x_continuous(breaks = 2015:2017) +
    labs(y = "%", x = "año", title = "TTH (%)", color = "", 
         alpha = "") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))

# que solo aparezca el panel si representa más del 1% del área
# mis_clases_madmex <- madmex_mi_anp_v$clase_madmex[madmex_mi_anp_v$prop > 1]
tasa_cambio_clase_aux <- perdida_anps_df %>% 
    # filter(clase_madmex %in% c(1:3, 6), clase_madmex %in% mis_clases_madmex) %>% 
    filter(clase_madmex %in% 1:3) %>% 
    group_by(anp, clase, clase_madmex) %>% 
    mutate(
        area_total = sum(n)
    )

tasa_cambio_clase_aux$n[tasa_cambio_clase_aux$anio_perdida == 2000] <- 0

tasa_cambio_clase <- tasa_cambio_clase_aux %>% 
    group_by(anp, clase, clase_madmex) %>% 
    mutate(
        cum_loss = cumsum(n),
        area_restante = area_total - cum_loss, 
        tasa_cambio = round(100 * (area_restante / lag(area_restante) - 1), 3)
        ) %>% 
    filter(anio_perdida > 2000) %>% 
    ungroup() %>% 
    mutate(clase_madmex = case_when(
        clase_madmex == 1 ~ "bosque", 
        clase_madmex == 2 ~ "selva", 
        clase_madmex == 3 ~ "matorrales"
        )
        ) %>% 
    select(anp, anio_perdida, tasa_cambio, clase, clase_madmex)

tasa_cambio_clase_cl <- tasa_cambio_clase %>% 
    left_join(perdida_anual_cobertura_porcentaje, 
    by = c("anp", "anio_perdida", "clase", "clase_madmex")) %>% 
    left_join(anp_nombres, by = c("anp" = "anp_sin_acentos")) %>% 
    filter(anio_perdida >= 2015) %>% 
    select(anp, ANP = anp_corto, año = anio_perdida, THH = tasa_cambio, 
        perdida_ha = ha_loss, clase, clase_madmex)

tasa_cambio_clase_mi_anp <- filter(tasa_cambio_clase_cl, anp == mi_anp)
tasa_cambio_clase_mi_anp_ring <- filter(tasa_cambio_clase_cl, 
    anp == str_c(mi_anp, "_ring"))

tasa_cambio_clase_plot <- ggplot(tasa_cambio_clase_cl, aes(label = perdida_ha)) + 
    geom_line(aes(x = año, y = THH, group = interaction(ANP, clase),
        color = clase, alpha = clase)) +
    scale_alpha_manual(values = escala_alpha) +
    scale_color_manual(values = escala_color) +
    scale_x_continuous(breaks = 2015:2017) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    labs(y = "%", x = "año", title = "TTH (%)", color = "",
         alpha = "") +
    facet_wrap(~clase_madmex) 

vars_tooltip <- c("ANP", "año", "THH", "perdida_ha")
p1 <- ggplotly(tasa_cambio_plot, tooltip = vars_tooltip, 
                 dynamicTicks = FALSE)
p2 <- ggplotly(tasa_cambio_clase_plot, tooltip = vars_tooltip, 
                 dynamicTicks = FALSE)
```

```{r tth_plot}
subplot(style(p1, traces = 1:5, showlegend = FALSE), p2, margin = 0.03)
```


Con el fin de comparar el grado de pérdida boscosa entre las ANPs de una misma 
región CONANP construímos un índice de pérdida forestal, el índice considera la
pérdida por ecorregión. Esto es porque es razonable considerar
que algunas ecorregiones sean sujetas a mayor amenaza de pérdida forestal que 
otras. 

```{r}
indice_deforestacion <- madmex_cobertura %>% 
    filter(tipo_id == 1) %>% 
    mutate(ultimos_5 = anio_perdida > 2012) %>% 
    group_by(anp) %>% 
    mutate(hectareas = sum(n)) %>% 
    group_by(anp, ultimos_5) %>% 
    summarise(deforestacion = sum(n) / first(hectareas) * 100) %>% 
    ungroup() %>% 
    filter(ultimos_5) %>% 
    left_join(select(manejo_ha_anp, anp, eco), by = "anp") %>% 
    group_by(eco) %>% 
    mutate(
        deforestacion_eco = mean(deforestacion),
        ind_deforestacion = round(deforestacion - deforestacion_eco, 2), 
        ind_cat = ind_deforestacion < 0
        ) 

# ecorregiones representadas en región CONANP
mis_eco_region <- indice_deforestacion %>% 
    filter(anp %in% mis_anps_region) %>% pull(eco) %>% unique()


tab_def_eco <- indice_deforestacion %>% 
    filter(!is.na(eco)) %>% 
    select(eco, deforestacion_eco) %>% 
    distinct() %>% 
    mutate(deforestacion_eco = round(deforestacion_eco, 2)) %>% 
    arrange(deforestacion_eco)

tab_def_eco %>% 
    kable("html", col.names = c("", "% perdida")) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
        position = "float_right", font_size = 11, full_width = FALSE) %>% 
    row_spec(which(tab_def_eco$eco %in% mis_eco_region), bold = F, color = "#79797d", 
        background = "mistyrose") 
```

Adicionalmente, medimos la pérdida como el porcentaje del área total de cada
ANP perdida por deforestación en los últimos 5 años de datos, en este caso entre 2011 y 2016.
La tabla de la derecha muestra el promedio de la deforestación de las ANPs de
cada ecorregión, en rosa se marcan aquellas ecorregiones presentes en la región 
de la ANP *`r mi_anp_print`*.

Una vez que calculamos el promedio de pérdida en cada ecorregión construimos
el índice como la diferencia entre la pérdida de cada ANP y la pérdida promedio
en la ecorregión a la que pertenece, es así que si una ANP ocurrió más 
pérdida boscosa que en el promedio de su ecorregión, el índice tomará un valor 
positivo. La gráfica de abajo indica el valor de los índices para todas las ANP
de la región *`r mi_region`*.

<div style="clear:both">
</div>

```{r deforestacion_region_conanp}
indice_deforestacion_cl <- indice_deforestacion %>% 
    filter(anp %in% mis_anps_region) %>% 
    left_join(anp_nombres, by = c("anp" = "anp_sin_acentos")) %>% 
    arrange(ind_deforestacion)

a <- ifelse(indice_deforestacion_cl$anp == mi_anp, "red", "gray30")
ggplot(indice_deforestacion_cl,
    aes(x = reorder(anp_corto, ind_deforestacion), y = ind_deforestacion, label = eco)) + 
    geom_bar(stat = 'identity', aes(fill = ind_cat), width = .5)  +
    scale_fill_manual(name = "", 
                    labels = c("mayor al promedio", "menor al promedio"), 
                    values = c("FALSE" = "#f8766d", "TRUE" = "#00ba38")) + 
  labs(title= "Pérdida boscosa en la región", x = "", y = "") + 
    coord_flip() +
    theme(axis.text.y = element_text(colour = a))
  
```

### Integridad y ACE

#### Integridad ecosistémica

La integridad ecosistémica se reporta mediante un índice construído por la CONABIO en colaboración con el INECOL, A.C.. Este índice relaciona de manera integral varios aespectos de la biodiversidad a través de modelos llamados redes bayesianas. Estos modelos representan relaciones intercruzadas entre variables descriptoras de los ecosistemas como lo son el tamaño y la cantidad de árboles presentes, imagenes satelitales y variables contextuales como lo son el clima y la topografía. Con base en esto, los modelos arrojan un predicción sobre el estado actual de los ecosistemas a lo largo del territorio nacional.

Para este reporte se trabajó con el mapa de integridad ecosistémica de 2014, 
con una resolución de 250 m^2^, el índice de integridad está estandarizado de 
manera que toma valores entre 0 y 1, donde 1 es el mayor valor de integridad. 


```{r ie_map, eval=TRUE}
estilos_ie <- filter(estilos_df, layer == "mex_ie_2014_250m")
leaflet() %>% 
    addProviderTiles(providers$Esri.WorldImagery) %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/geoportal/wms",
        layers = "mex_ie_2014_250m",
        options = WMSTileOptions(format = "image/png", transparent = TRUE), 
        group = "Capa"
        ) %>%
    fitBounds(lng1 = xmin, lat1 = ymin, lng2 = xmax, lat2 = ymax) %>% 
    addProviderTiles(providers$Esri.WorldImagery, group = "Terreno") %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/geoportal/wms",
        layers = "mex_ANPTerr175_2017",
        options = WMSTileOptions(format = "image/png", transparent = TRUE, 
        opacity = 0.5), group = "ANP"
        ) %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/geoportal/wms",
        layers = "mex_ZN_terr_geoITRF08_Mayo18",
        options = WMSTileOptions(format = "image/png", transparent = TRUE, 
        opacity = 0.6), group = "Núcleo-Pres."
        ) %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/reportes/wms",
        layers = "mex_ANPTerr175_2017_rings",
        options = WMSTileOptions(format = "image/png", transparent = TRUE, 
        opacity = 0.3), group = "Periferia"
        ) %>% 

    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/reportes/wms",
        layers = "GapPriorExtrema", group = "GAP",
        options = WMSTileOptions(format = "image/png", transparent = TRUE)) %>%
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/reportes/wms",
         layers = "LocPob2500", group = "Loc 2500",
         options = WMSTileOptions(format = "image/png", transparent = TRUE)
        ) %>%
    addLegend("bottomright", colors = estilos_ie$colors[[1]],
        title = "IE", labels = estilos_ie$labels[[1]], 
        opacity = 1, group = "leyenda") %>%
    addLayersControl(
        baseGroups = c("Capa", "Terreno"),
        overlayGroups = c("leyenda", "ANP", "GAP", "Loc 2500", "Periferia",
            "Núcleo-Pres."),
        options = layersControlOptions(collapsed = FALSE)
        )  %>%
    hideGroup("GAP") %>% 
    hideGroup("Loc 2500") %>% 
    hideGroup("Periferia") %>% 
    hideGroup("Núcleo-Pres.")
```


</br>

```{r}
ie_stats <- read_csv("../datos_procesados/2018-07-27_ie_stats.csv")
ie_samples <- read_csv("../datos_procesados/2018-07-27_ie_list_valores_anp.csv")
# ie_samples <- map_df(ie_list, ~data_frame(anp = .$anp, ie_pixeles = .$valores)) %>% 
#     mutate(
#         anp = str_replace(anp, "anp_terrestres_2017_NOMBRE_", ""), 
#         anp_corto = str_sub(anp, start = 1, end = 20),
#         clase = ifelse(anp == mi_anp, mi_anp, "otras")
#         ) %>% 
#     filter(anp %in% mis_anps) 

mis_ie_samples <- ie_samples %>% 
    filter(anp %in% mis_anps_eco, tipo_id == 1)  %>% 
    left_join(anp_nombres, by = c("anp" = "anp_sin_acentos")) %>% 
    mutate(
        clase = case_when(anp == mi_anp ~ mi_anp_corto, TRUE ~ "otras")
        ) 
mis_ie_stats <- ie_stats %>% 
    filter(anp %in% mis_anps_eco, tipo_id != 1)  %>% 
    left_join(anp_nombres, by = c("anp" = "anp_sin_acentos")) %>% 
        mutate(
            clase = case_when(
                tipo_id == 2 ~ "periferia",
                tipo_id == 3 ~ "z.núcleo",
                tipo_id == 4 ~ "z.preservación"
            ) 
        )

mi_anp_ie_stats <- ie_stats %>% 
    filter(anp == mi_anp, tipo_id == 1)
```


El mapa de arriba nos da un panorama de la integridad en la ANP *`r mi_anp_print`*, que
tiene una media de integridad de `r round(mi_anp_ie_stats$media, 2)` y una desviación estándar
de `r round(mi_anp_ie_stats$desv_est, 2)`. La gráfica de abajo busca contextualizar estos 
números comparando los valores integridad de *`r mi_anp_print`* con los correspondientes a otras
ANP en la misma ecorregión y con los valores en los anillos.


<div style= "float:left;position: relative; top: -10px;">

```{r ie_boxplot, fig.width = 4.5, fig.height=6}
    
ie_boxplot <- ggplot() +
    coord_flip() +
    geom_boxplot(data = mis_ie_samples, aes(x = reorder(anp_corto, valores, median),
        y = valores, color = clase), alpha = 0.6, show.legend = FALSE, 
        outlier.color = "gray90", coef = 0) +
    scale_color_manual("", values = escala_color) +
    geom_point(data = mis_ie_stats, aes(x = anp_corto, y = mediana, 
        color = clase), alpha = 0.8) +
    labs(x = ",", title = "Integridad Ecosistémica", y = "")

ie_boxplot
```
</div>

</br>
Con el fin de mostrar tanto el nivel de integridad en cada ANP como la 
variación en la integridad tomamos para cada ANP una muestra aleatoria de 1000 
pixeles y construimos diagramas de los valores de integridad de los pixeles en 
la muestra. 

- La **mediana** de la integridad de las ANPs está representada por las líneas 
que dividen las cajas, si queremos pensar en un único valor para caracterizar la 
integridad de una ANP podemos usar la mediana, con esto en mente las ANP con mayor 
integridad ecosistémica son las primeras y conforme descendemos en la gráfica
disminuye la integridad.

- Los puntos **azules** representan la **mediana** de integridad en los anillos de
cada ANP, esto nos sirve para comparar la integridad de cada ANP con la 
correspondiente al anillo que la rodea.

- La longitud de las **cajas** es el rango intercuantil, esto es el 50% de los 
valores centrales de integridad están contenidos en la caja. Y los puntos 
grises corresponden a los pixeles que caen fuera del rango central.

</br>

<div style="clear:both">
</div>


### Fauna

La idoneidad de hábitat se refiere a las condiciones locales de preferencia de 
una especie. Se utilizan registros georreferidos del SNMB obtenidos a partir 
de fototrampeo, huellas, excretas, registros fotográficos, del 
SNIB (Sistema Nacional de Información de la Biodiversidad, COBANIO) y los 
registros de la plataforma de Naturalista en vida libre.

El año del registro es importante para asociarlo con la condición del sitio en 
el año que fue observado o capturado. Todos los registros de la especie de 
interés se relacionan espacio-temporalmente con las coberturas de hábitat como, 
la estructura de la vegetación (INFyS) y las obtenidas de imágenes por 
percepción remota (Land Sat).

```{r}
secciones <- read_csv("../datos_insumo/puma_ponca_anps.csv") %>% 
    filter(ID_07 == mi_anp_id_07) %>% 
    mutate_if(is.numeric, funs(!is.na(.)))
puma <- secciones$`Puma concolor`
ponca <- secciones$`Panthera onca`
```

`r ifelse(puma, "
#### Puma concolor

El siguiente mapa nos muestra las variaciones en la idoneidad dentro de la ANP
para el año 2014.
", "")`

```{r, eval=puma}
estilos_ihpuma <- filter(estilos_df, layer == "mex_pconcolorB1suitability_2014")

leaflet() %>%
    fitBounds(lng1 = xmin, lat1 = ymin, lng2 = xmax, lat2 = ymax) %>% 
    addProviderTiles(providers$Esri.WorldImagery) %>% 
    addProviderTiles(providers$Esri.WorldImagery, group = "Terreno") %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/geoportal/wms",
        layers = "mex_pconcolorB1suitability_2014",
        options = WMSTileOptions(format = "image/png", transparent = TRUE), 
        group = "Capa"
        ) %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/geoportal/wms",
        layers = "mex_ANPTerr175_2017",
        options = WMSTileOptions(format = "image/png", transparent = TRUE, 
        opacity = 0.5), group = "ANP"
        ) %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/geoportal/wms",
        layers = "mex_ZN_terr_geoITRF08_Mayo18",
        options = WMSTileOptions(format = "image/png", transparent = TRUE, 
        opacity = 0.6), group = "Núcleo-Pres."
        ) %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/reportes/wms",
        layers = "mex_ANPTerr175_2017_rings",
        options = WMSTileOptions(format = "image/png", transparent = TRUE, 
        opacity = 0.3), group = "Periferia"
        ) %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/reportes/wms",
        layers = "GapPriorExtrema", group = "GAP",
        options = WMSTileOptions(format = "image/png", transparent = TRUE)) %>%
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/reportes/wms",
         layers = "LocPob2500", group = "Loc 2500",
         options = WMSTileOptions(format = "image/png", transparent = TRUE)
        ) %>%
    addLegend("bottomright", colors = estilos_ihpuma$colors[[1]],
        title = "IH Puma", labels = estilos_ihpuma$labels[[1]], 
        opacity = 1, group = "leyenda") %>%
    addLayersControl(
        baseGroups = c("Capa", "Terreno"),
        overlayGroups = c("leyenda", "ANP", "GAP", "Loc 2500", "Periferia", 
            "Núcleo-Pres."),
        options = layersControlOptions(collapsed = FALSE)
        )  %>%
    hideGroup("GAP") %>% 
    hideGroup("Loc 2500") %>% 
    hideGroup("Periferia") %>% 
    hideGroup("Núcleo-Pres.")
```

`r ifelse(puma, "
La siguiente gráfica nos muestra la distribución de la idoneidad a lo largo de 
los años 2005 a 2014. Los puntos azules corresponden a la idoneidad de hábitat 
para el puma en el anillo circundante a la ANP.
", "")

```{r, fig.width=4, fig.height=3, eval = puma}
load("../datos_procesados/2018-08-24_suitabilility_report.RData")

mi_tabla_suit_anp <- tabla_suit %>% 
    filter(anp == mi_anp) 

mi_ih_stats <- suit_stats %>%
    ungroup() %>% 
    filter(anp == mi_anp, tipo != "ANP") %>% 
    mutate(
        clase = case_when(
            tipo == "anillo" ~ "periferia",
            tipo == "núcleo" ~ "z.núcleo",
            tipo == "preservación" ~ "z.preservación"
        )
    )

escala_color_sin_anp <- c("#005b96", "#7CCD7C", "#AB82FF")
names(escala_color_sin_anp) <- c("periferia", "z.núcleo", "z.preservación")
plot_ih_anio <- ggplot(mi_tabla_suit_anp, aes(x = factor(anio), y = idoneidad)) +
    geom_boxplot(alpha = 0.6, show.legend = FALSE, 
        outlier.color = "gray90", coef = 0, color = "gray50") +
    geom_point(data = mi_ih_stats, aes(x = factor(anio), y = mediana, 
        color = clase)) +
    scale_color_manual("", values = escala_color_sin_anp) +
    labs(x = "año", y = "", title = "Idoneidad de hábitat", color = "")

ggplotly(plot_ih_anio)
```

<!--
Percentil 75 de idoneidad en la ANP y el anillo que la rodea. La línea roja 
corresponde a la ANP y la 
línea azúl al anillo.
-->

```{r, fig.width=4, fig.height=3, echo=FALSE, include=FALSE, eval=FALSE}
load("../datos_procesados/2018-02-12_suitability.RData")

tabla_suit_l <- tabla_suit %>% 
    as_tibble() %>% 
    filter(anp == mi_anp) %>% 
    gather(anio, suit, -anp, -x, -y) %>% 
    mutate(
        anio = readr::parse_number(anio), 
        id = str_c(x, y, sep = "-")
        ) %>% 
    filter(anio > 2004) %>% 
    group_by(anio) %>% 
    summarise(percentil_75 = quantile(suit, probs = 0.75, na.rm = TRUE))

tabla_suit_rings_l <- tabla_suit_rings %>% 
    as_tibble() %>% 
    filter(anp == str_c(mi_anp, "_ring")) %>% 
    gather(anio, suit, -anp, -x, -y) %>% 
    mutate(
        anio = readr::parse_number(anio), 
        id = str_c(x, y, sep = "-")
        ) %>% 
    filter(anio > 2004) %>% 
    group_by(anio) %>% 
    summarise(percentil_75 = quantile(suit, probs = 0.75, na.rm = TRUE))

ggplot(tabla_suit_l, aes(x = anio, y = percentil_75)) +
    geom_line(color = "red") +
    geom_line(data = tabla_suit_rings_l, aes(x = anio, y = percentil_75), 
        color = "blue") +
    geom_text(data = tabla_suit_l, aes(x = anio[1], y = percentil_75[1]), 
        label = "ANP", color = "red", hjust = 0, vjust = 0) +
    geom_text(data = tabla_suit_rings_l, aes(x = anio[1], y = percentil_75[1]), 
        label = "anillo", color = "blue", hjust = 0, vjust = 0) +
    scale_x_continuous(breaks = 2005:2014) +
    labs(x = "año", y = "", title = "Idoneidad de hábitat")
```

```{r ih_boxplot, fig.width = 4.5, fig.height=6, include=FALSE, eval=puma}
load("../datos_procesados/2018-02-12_suitability.RData")

tabla_suit_plot <- tabla_suit %>% 
    select(anio, anp_sin_acentos = anp, suit = idoneidad) %>% 
    filter(anio == 2014) %>% 
    left_join(anp_nombres) %>% 
    mutate(
        clase = ifelse(anp_sin_acentos == mi_anp, mi_anp_corto, "otras")
    ) %>% 
    filter(anp_sin_acentos %in% mis_anps_eco) 

tabla_suit_rings_median <- tabla_suit_rings %>% 
    mutate(anp_sin_acentos = anp) %>% 
    select(anio, anp_sin_acentos, suit = idoneidad) %>% 
    filter(anio == 2014) %>% 
    left_join(anp_nombres) %>% 
    mutate(
        clase = ifelse(anp_sin_acentos == mi_anp, mi_anp_corto, "otras")
    ) %>% 
    filter(anp_sin_acentos %in% mis_anps_eco) %>% 
    group_by(anp_corto) %>% 
    summarise(mediana_anillo = median(suit))

ie_boxplot <- ggplot() +
    coord_flip() +
    geom_boxplot(data = tabla_suit_plot, aes(x = reorder(anp_corto, suit, median),
        y = suit, color = clase), alpha = 0.6, show.legend = FALSE, 
        outlier.color = "gray90", coef = 0) +
    scale_color_manual("", values = escala_color) +
    geom_point(data = tabla_suit_rings_median, aes(x = anp_corto, 
        y = mediana_anillo), color = "blue", alpha = 0.8) +
    labs(x = ",", title = "Integridad Ecosistémica", y = "")

ie_boxplot
```

`r ifelse(puma, "
Las coberturas ambientales se obtienen anualmente por lo que aunque todos
los registros del *Puma concolor* del periodo completo (2004 al 2014 en este 
caso) 
ayudan a caracterizar el nicho ecológico con la mayor información disponible de la especie, 
es factible además reproyectar dichas condiciones al espacio geográfico anualmente 
(hdm, R package).

Del modelo desarrollado se seleccionan las variables ambientales que 
muestran mejor desempeño en los modelos y que además están menos correlacionadas 
entre ellas. Así es como todas las combinaciones de las variables de hábitat se 
modelan con base en un elipsoide de tres dimensiones. Se crea la caracterización 
del nicho ambiental del hábitat de cada especie. 

La razón de usar los elipsoides como aproximación geométrica del nicho ecológico 
se sustenta en los trabajos teóricos y experimentales que proponen que la forma 
de los nichos es convexa y que se asemeja a un elipsoide (Birch, 1953; Maguire, 
1967; Hooper et al, 2008; Angilletta, 2009; Soberón & Nakamura, 2009; Soberón & 
Peterson, 2011; Qiao et al, 2016). Así el centro del elipsoide es una 
aproximación de las mejores condiciones por lo que representan las regiones con 
la mejor calidad o idoneidad de hábitat en este caso del Puma.


Los diagramas de caja y brazos del abajo buscan comparar la idoneidad de 
hábitat para el *Puma concolor* a lo largo de las ANPs que pertenecen a la región 
CONANP de la ANP.
", "")`

```{r ih_boxplot_2, fig.width = 4.5, fig.height=6, eval=puma}
ih_stats_2014 <- suit_stats %>% 
    ungroup() %>% 
    filter(anio == 2014, tipo != "ANP", anp %in% mis_anps_region) %>% 
    select(anp_sin_acentos = anp, mediana, tipo) %>% 
    left_join(anp_nombres) %>% 
    mutate(
        clase = case_when(
            tipo == "anillo" ~ "periferia",
            tipo == "núcleo" ~ "z.núcleo",
            tipo == "preservación" ~ "z.preservación"
        )
        ) 

tabla_suit_region <- tabla_suit %>% 
    rename(anp_sin_acentos = anp) %>%
    filter(anio == 2014, anp_sin_acentos %in% mis_anps_region) %>% 
    left_join(anp_nombres) %>% 
    mutate(
        clase = ifelse(anp_sin_acentos == mi_anp, mi_anp_corto, "otras")
    ) 

ie_boxplot <- ggplot() +
    coord_flip() +
    geom_boxplot(data = tabla_suit_region, aes(x = reorder(anp_corto, idoneidad, 
        median), y = idoneidad, color = clase), alpha = 0.6, show.legend = FALSE, 
        outlier.color = "gray90", coef = 0) +
    scale_color_manual("", values = escala_color) +
    geom_point(data = ih_stats_2014, aes(x = anp_corto, 
        y = mediana, color = clase),  alpha = 0.8) +
    labs(x = ",", title = "Idoneidad de hábitat", y = "")

ie_boxplot
```


`r ifelse(ponca, "
#### Panthera Onca

El siguiente mapa nos muestra las variaciones en la idoneidad dentro de la ANP
para el año 2014.
", "")`

```{r, eval=ponca}
estilos_ihponca <- filter(estilos_df, layer == "mex_poncaB1suitability_2014")

leaflet() %>%
    fitBounds(lng1 = xmin, lat1 = ymin, lng2 = xmax, lat2 = ymax) %>% 
    addProviderTiles(providers$Esri.WorldImagery) %>% 
    addProviderTiles(providers$Esri.WorldImagery, group = "Terreno") %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/geoportal/wms",
        layers = "mex_poncaB1suitability_2014",
        options = WMSTileOptions(format = "image/png", transparent = TRUE), 
        group = "IH Jaguar"
        ) %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/geoportal/wms",
        layers = "mex_ANPTerr175_2017",
        options = WMSTileOptions(format = "image/png", transparent = TRUE, 
        opacity = 0.5), group = "ANP"
        ) %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/geoportal/wms",
        layers = "mex_ZN_terr_geoITRF08_Mayo18",
        options = WMSTileOptions(format = "image/png", transparent = TRUE, 
        opacity = 0.6), group = "Núcleo-Pres."
        ) %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/reportes/wms",
        layers = "mex_ANPTerr175_2017_rings",
        options = WMSTileOptions(format = "image/png", transparent = TRUE, 
        opacity = 0.3), group = "Periferia"
        ) %>% 
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/reportes/wms",
        layers = "GapPriorExtrema", group = "GAP",
        options = WMSTileOptions(format = "image/png", transparent = TRUE)) %>%
    addWMSTiles("https://monitoreo.conabio.gob.mx/geoserver/reportes/wms",
         layers = "LocPob2500", group = "Loc 2500",
         options = WMSTileOptions(format = "image/png", transparent = TRUE)
        ) %>%
    addLegend("bottomright", colors = estilos_ihponca$colors[[1]],
        title = "IH P.Onca", labels = estilos_ihponca$labels[[1]], 
        opacity = 1, group = "leyenda") %>%
    addLayersControl(
        baseGroups = c("Capa", "Terreno"),
        overlayGroups = c("leyenda", "ANP", "GAP", "Loc 2500", "Periferia", 
            "Núcleo-Pres."),
        options = layersControlOptions(collapsed = FALSE)
        )  %>%
    hideGroup("GAP") %>% 
    hideGroup("Loc 2500") %>% 
    hideGroup("Periferia") %>% 
    hideGroup("Núcleo-Pres.")
```

`r ifelse(ponca, "
La siguiente gráfica nos muestra la distribución de la idoneidad a lo largo de 
los años 2005 a 2014. Los puntos azules corresponden a la idoneidad de hábitat 
para la panthera onca en el anillo circundante a la ANP.
", "")

```{r, fig.width=4, fig.height=3, eval = ponca}
load("../datos_procesados/2019-02-14_suitabilility_report_ponca.RData")

mi_tabla_suit_anp <- tabla_suit %>% 
    filter(anp == mi_anp) 

mi_ih_stats <- suit_stats %>%
    ungroup() %>% 
    filter(anp == mi_anp, tipo != "ANP") %>% 
    mutate(
        clase = case_when(
            tipo == "anillo" ~ "periferia",
            tipo == "núcleo" ~ "z.núcleo",
            tipo == "preservación" ~ "z.preservación"
        )
    )

escala_color_sin_anp <- c("#005b96", "#7CCD7C", "#AB82FF")
names(escala_color_sin_anp) <- c("periferia", "z.núcleo", "z.preservación")
plot_ih_anio <- ggplot(mi_tabla_suit_anp, aes(x = factor(anio), y = idoneidad)) +
    geom_boxplot(alpha = 0.6, show.legend = FALSE, 
        outlier.color = "gray90", coef = 0, color = "gray50") +
    geom_point(data = mi_ih_stats, aes(x = factor(anio), y = mediana, 
        color = clase)) +
    scale_color_manual("", values = escala_color_sin_anp) +
    labs(x = "año", y = "", title = "Idoneidad de hábitat", color = "")

ggplotly(plot_ih_anio)
```


```{r ih_boxplot_ponca, fig.width = 4.5, fig.height=6, include=FALSE, eval=ponca}
load("../datos_procesados/2019-01-25_suitability_ponca.RData")

tabla_suit_plot <- tabla_suit %>% 
    select(anio, anp_sin_acentos = anp, suit = idoneidad) %>% 
    filter(anio == 2014) %>% 
    left_join(anp_nombres) %>% 
    mutate(
        clase = ifelse(anp_sin_acentos == mi_anp, mi_anp_corto, "otras")
    ) %>% 
    filter(anp_sin_acentos %in% mis_anps_eco) 

tabla_suit_rings_median <- tabla_suit_rings %>% 
    mutate(anp_sin_acentos = anp) %>% 
    select(anio, anp_sin_acentos, suit = idoneidad) %>% 
    filter(anio == 2014) %>% 
    left_join(anp_nombres) %>% 
    mutate(
        clase = ifelse(anp_sin_acentos == mi_anp, mi_anp_corto, "otras")
    ) %>% 
    filter(anp_sin_acentos %in% mis_anps_eco) %>% 
    group_by(anp_corto) %>% 
    summarise(mediana_anillo = median(suit))

ie_boxplot <- ggplot() +
    coord_flip() +
    geom_boxplot(data = tabla_suit_plot, aes(x = reorder(anp_corto, suit, median),
        y = suit, color = clase), alpha = 0.6, show.legend = FALSE, 
        outlier.color = "gray90", coef = 0) +
    scale_color_manual("", values = escala_color) +
    geom_point(data = tabla_suit_rings_median, aes(x = anp_corto, 
        y = mediana_anillo), color = "blue", alpha = 0.8) +
    labs(x = ",", title = "Integridad Ecosistémica", y = "")

ie_boxplot
```

`r ifelse(ponca, "
Las coberturas ambientales se obtienen anualmente por lo que aunque todos
los registros del *Panthera onca* del periodo completo (2004 al 2014 en este 
caso) 
ayudan a caracterizar el nicho ecológico con la mayor información disponible de la especie, 
es factible además reproyectar dichas condiciones al espacio geográfico anualmente 
(hdm, R package).

Del modelo desarrollado se seleccionan las variables ambientales que 
muestran mejor desempeño en los modelos y que además están menos correlacionadas 
entre ellas. Así es como todas las combinaciones de las variables de hábitat se 
modelan con base en un elipsoide de tres dimensiones. Se crea la caracterización 
del nicho ambiental del hábitat de cada especie. 

La razón de usar los elipsoides como aproximación geométrica del nicho ecológico 
se sustenta en los trabajos teóricos y experimentales que proponen que la forma 
de los nichos es convexa y que se asemeja a un elipsoide (Birch, 1953; Maguire, 
1967; Hooper et al, 2008; Angilletta, 2009; Soberón & Nakamura, 2009; Soberón & 
Peterson, 2011; Qiao et al, 2016). Así el centro del elipsoide es una 
aproximación de las mejores condiciones por lo que representan las regiones con 
la mejor calidad o idoneidad de hábitat en este caso del Puma.


Los diagramas de caja y brazos del abajo buscan comparar la idoneidad de 
hábitat para *Panthera onca* a lo largo de las ANPs que pertenecen a la región 
CONANP de la ANP.
", "")`

```{r ih_boxplot_2_ponca, fig.width = 4.5, fig.height=6, eval=ponca}
ih_stats_2014 <- suit_stats %>% 
    ungroup() %>% 
    filter(anio == 2014, tipo != "ANP", anp %in% mis_anps_region) %>% 
    select(anp_sin_acentos = anp, mediana, tipo) %>% 
    left_join(anp_nombres) %>% 
    mutate(
        clase = case_when(
            tipo == "anillo" ~ "periferia",
            tipo == "núcleo" ~ "z.núcleo",
            tipo == "preservación" ~ "z.preservación"
        )
        ) 

tabla_suit_region <- tabla_suit %>% 
    rename(anp_sin_acentos = anp) %>%
    filter(anio == 2014, anp_sin_acentos %in% mis_anps_region) %>% 
    left_join(anp_nombres) %>% 
    mutate(
        clase = ifelse(anp_sin_acentos == mi_anp, mi_anp_corto, "otras")
    ) 

ie_boxplot <- ggplot() +
    coord_flip() +
    geom_boxplot(data = tabla_suit_region, aes(x = reorder(anp_corto, idoneidad, 
        median), y = idoneidad, color = clase), alpha = 0.6, show.legend = FALSE, 
        outlier.color = "gray90", coef = 0) +
    scale_color_manual("", values = escala_color) +
    geom_point(data = ih_stats_2014, aes(x = anp_corto, 
        y = mediana, color = clase),  alpha = 0.8) +
    labs(x = ",", title = "Idoneidad de hábitat", y = "")

ie_boxplot
```

### Referencias y materiales

Angilletta, M. J. (2009) Thermal adaptation: a theoretical and empirical synthesis. Oxford Univ. Press.

Birch, L. C. (1953) Experimental background to the study of the distribution and abundance of insects: III. The relation between innate capacity for increase and survival of different species of beetles living together on the same food. Evolution 7, pp. 136–144.

Bryan C. Pijanowski, Luis J. Villanueva-Rivera, Sarah L. Dumyahn, Almo Farina, Bernie L. Krause, Brian M. Napoletano, Stuart H. Gage and Nadia Pieretti, Soundscape Ecology: The Science of Sound in the Landscape, BioScience, Vol. 61, No. 3 (March 2011), pp. 203-216, University of California Press on behalf of the American Institute of Biological Sciences

Garcia-Alaniz, N.; Equihua, M.; Pérez-Maqueo O.;Equihua, J.;Pardo F.;Martínez, J.; Villela, S.; Schmidt, M., The Mexican National Biodiversity and Ecosystem Degradation Monitoring System, Current Opinion in Evironmental Sustainability, 2017, 26-27, 62–68.

Gebhardt, S.; Wehrmann, T.; Ruiz, M.A.M.; Maeda, P.; Bishop, J.; Schramm, M.; Kopeinig, R.; Cartus, O.; Kellndorfer, J.; Ressl, R.; Santos, L.A.; Schmidt, M.	MAD-MEX: Automatic Wall-to-Wall Land Cover Monitoring for the Mexican REDD-MRV Program Using All Landsat Data. Remote Sens. 2014, 6, 3923-3943.

Gebhardt, S.; Maeda, P.; Wehrmann, T.; Argumedo, J.; A PROPER LAND COVER AND FOREST TYPE CLASSIFICATION SCHEME FOR
MEXICO. The International Archives of the Photogrammetry, Remote Sensing and Spatial Information Sciences, Volume XL-7/W3, 2015
36th International Symposium on Remote Sensing of Environment, 11–15, May 2015, Berlin, Germany.

Hansen, M. C., P. V. Potapov, R. Moore, M. Hancher, S. A. Turubanova, A. Tyukavina, D. Thau, S. V. Stehman, S. J. Goetz, T. R. Loveland, A. Kommareddy, A. Egorov, L. Chini, C. O. Justice, and J. R. G. Townshend. 2013. “High-Resolution Global Maps of 21st-Century Forest Cover Change.” Science 342 (15 November): 850–53.

Hooper, H. L. et al. (2008) The ecological niche of Daphnia magna characterized using population growth rate. Ecology 89, pp. 1015–1022.

Landsat imagery, NASA Land Processes Distributed Active Archive Center (LP DAAC) Products,These data are distributed by the Land Processes Distributed Active Archive Center (LP DAAC), located at USGS/EROS, Sioux Falls, SD. http://lpdaac.usgs.gov

Maguire, Jr., B. (1973). Niche Response Structure and the Analytical Potentials of Its Relationship to the Habitat. The American Naturalist. http://doi.org/10.1086/282827

Qiao, H., Peterson, A. T., Campbell, L. P., Soberón, J., Ji, L. and Escobar, L. E. (2016), NicheA: creating virtual species and ecological niches in multivariate environmental scenarios. Ecography, 39, pp. 805–813. doi: 10.1111/ecog.01961

Soberón, J. and Nakamura, M. (2009) Niches and distributional areas: concepts, methods, and assumptions. Proc. Natl Acad. Sci. USA 106, pp. 19644–19650. Tropical and Subtropical Agroecosystems, 16, pp. 183–191

